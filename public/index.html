<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="text/javascript" src="./js/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="./css/menu.css"> <!-- https://125naroom.com/web/2958 -->
  <script type="text/javascript" src="./js/menu.js"></script> <!-- https://125naroom.com/web/2958 -->
  <link rel="stylesheet" href="./css/main.css">
  <link rel="stylesheet" href="./css/table.css">
  <link rel="stylesheet" href="./css/tasks.css">
  <link rel="stylesheet" href="./css/button.css">
  <script type="text/javascript" src="./js/tasks.js"></script>

  <!-- Bootstrap の css をインポートする。参考 https://getbootstrap.jp/docs/4.5/getting-started/introduction/　-->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

  <!-- モバイルブラウザでのレイアウトを制御する。参考 https://qiita.com/ryounagaoka/items/045b2808a5ed43f96607 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

  <!-- 検索エンジンに引っかからないようにする。参考 https://ameblo.jp/masa30201/entry-11564231810.html -->
  <meta name="Keywords" content="norobot">

  <!--  -->
  <script src="/__/firebase/8.10.0/firebase-app.js"></script>
  <script src="/__/firebase/8.10.0/firebase-firestore.js"></script>
  <script src="/__/firebase/8.10.0/firebase-auth.js"></script>
  <script src="/__/firebase/8.10.0/firebase-messaging.js"></script>
  <script src="/__/firebase/init.js"></script>

  <!-- jQuery, Bootstrap の JSライブラリ をロードする。参考 https://getbootstrap.jp/docs/4.5/getting-started/introduction/ -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
    </script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
    </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous">
    </script>


  <!-- android のブラウザを全画面表示にさせる -->
  <meta name="mobile-web-app-capable" content="yes">

  <!-- iOS のブラウザを全画面表示にさせる -->
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- CSS の定義 -->
  <style>
    /*  文字の色を指定 */
    .fontBlue {
      color: blue;
    }

    .fontRed {
      color: red;
    }
  </style>
  <script>
    let db = firebase.firestore(); // データベースに関する機能の取得

    // 保持されている全てのタスクデータを取得し、表示する
    function getAll() {
      let collection = db.collection("tasks").orderBy('duedate', 'asc'); // 作成された順にデータを並べてタスクデータをデータベースから取得する
      collection.get().then((querySnapshot) => { // 取得したデータを読み取る
        $('#list').text('') // タスクをリスト表示するための箇所（<div id="list"></div>）を空文字に設定（初期化）

        // 変数の初期化
        outputAll = [];
        num = 0;

        querySnapshot.forEach((doc) => { // 取得したデータそれぞれ1つづつのデータに対して
          let status = "";
          if (doc.data()['done']) {
            status = "checked"
          } // タスクが完了の状態になっているかの判定
          // リスト表示するための箇所（ <div id="list"></div> ）にタスクを最下端に追加
          $('#list').append(' \
      <div class="row mx-auto">\
        <div class="col-sm"> \
          <form class="form-inline"> \
            <div class="custom-control custom-checkbox"> \
              <input value="' + doc.id + '" type="checkbox" class="custom-control-input" id="customCheck' + num +
            '" ' + status + ' onclick="check(this);"> \
              <label class="custom-control-label" for="customCheck' + num + '"> \
              <div class="detail"> \
                <span class="duedate">'+ doc.data()['duedateYY'] + '年' + doc.data()['duedateMM'] + '月' + doc.data()['duedateDD'] + '日 ' + doc.data()['duedateHH'] + ':' + doc.data()['duedateMIN'] + '</span> \
                <span class="taskname">'+ doc.data()['title'] + '</span> \
                <span class="lecturename">('+ doc.data()['subject'] + ')</span> \
                  [<a value="' + doc.id + '" data-toggle="modal" data-target="#addTask" onclick="showEditModal(this)"> <span class="fontBlue">編集</span> </a>] \
                  [<a value="' + doc.id + '" data-toggle="modal" data-target="#addTask" onclick="showDeleteModal(this)"> <span class="fontRed">削除</span> </a>] \
                  - Added by ' + doc.data()['create_by_name'] + '\
                  \
              </div> \
            </div> \
          </form> \
        </div> \
      </div>');
          num++;
        });
      });
    }
    getAll(); // 保持されている全てのタスクデータ取得の初期実行（これがないと、画面を開いたときに何も表示されない）

    // タスクを追加する
    function add() {
      let tasktitle = $("#tasktitle").val(); // inputbox に入力された値を取得する
      if (tasktitle == "") return; // もし、inputbox が空だった場合は関数を終了する
      let tasksubject = $("#tasksubject").val(); // inputbox に入力された値を取得する
      let datepicker = new Date($("#datepicker").val()); // inputbox に入力された値を取得する

      db.collection("tasks").add({ // データベースにタスクを追加する
        create_by_uid: user.uid,
        create_by_name: user.displayName,
        create_at: new Date(), // 現在時刻
        title: tasktitle, // タイトル
        done: false, // タスクの完了状態は最初は未の状態のため false を指定
        subject: tasksubject, // 科目
        duedate: datepicker, // 締切日
        duedateYY: datepicker.getFullYear(), // 締切日(年)
        duedateMM: datepicker.getMonth() + 1, // 締切日(月), getMonth(): 0 -> Januaryらしい
        duedateDD: datepicker.getDate(), // 締切日(日)
        duedateHH: ('00' + (datepicker.getHours())).slice(-2), // 締切日(時)
        duedateMIN: ('00' + (datepicker.getMinutes())).slice(-2) // 締切日(分)
      }).then(function (docRef) { // 成功した場合に実行される箇所
        getAll(); // 保持されている全てのタスクデータを取得し、表示する
        // $("#tasktitle").val(''); // inputbox に入力された値を空にする
        // $("#tasksubject").val(''); // inputbox に入力された値を空にする
        // $("#datepicker").val(''); // inputbox に入力された値を空にする
        console.log("Document written with ID: ", docRef.id);
        var params = {
          username: "Mintas",
          avatar_url: 'https://github.com/19K0111/OpenHackU2021-hello_world/blob/main/public/img/favicon.png',
          content: '課題が追加されました。',
          embeds: [
            {
              "title": tasktitle,
              "color": 15258703,
              "thumbnail": {
                "url": "",
              },
              "fields": [
                {
                  "name": "Due Date",
                  "value": datepicker.getMonth() + 1 + '月' + datepicker.getDate() + '日 ' + ('00' + (datepicker.getHours())).slice(-2) + ':' + ('00' + (datepicker.getMinutes())).slice(-2),
                  "inline": true
                }
              ]
            }
          ]
        }

        let urls = ['https://discord.com/api/webhooks/880516689463246848/NM_gRjqt2SY3wfmPa3KrDCNybll7y3KLpGieDwS9CVNC54Yt-0JD3YMO2Vc3m-Uh3Ar5'];
        const u = 'https://discord.com/api/webhooks/880516689463246848/NM_gRjqt2SY3wfmPa3KrDCNybll7y3KLpGieDwS9CVNC54Yt-0JD3YMO2Vc3m-Uh3Ar5';
        // for (url in urls) {
        fetch('https://discord.com/api/webhooks/880516689463246848/NM_gRjqt2SY3wfmPa3KrDCNybll7y3KLpGieDwS9CVNC54Yt-0JD3YMO2Vc3m-Uh3Ar5', {
          method: "POST",
          headers: {
            'Content-type': 'application/json'
          },
          body: JSON.stringify(params)
        }).then(res => {
          console.log(res);
          // window.location.reload();
        })
        // }
      })
        .catch(function (error) { // 失敗した場合に実行される箇所
          console.error("Error adding document: ", error);
        });
    }

    // タスクを削除する
    function del() {
      db.collection("tasks").doc($('#docId').val()).delete() // $('#docId').val() で削除する対象データのIDを取得し、そのデータに対して削除を行う
        .then(function () { // 成功した場合に実行される箇所
          console.log("Document successfully deleted!");
          $('#list').text = "" // タスクをリスト表示するための箇所（<div id="list"></div>）を空文字に設定（初期化）
          // $("#addTask").modal('toggle'); // Modal の表示を OFF にする
          getAll(); // 保持されている全てのタスクデータを取得し、表示する
          window.location.reload();
        }).catch(function (error) { // 失敗した場合に実行される箇所
          console.error("Error removing document: ", error);
        });
    }

    // タスクを更新する
    function update() {
      let tasktitle = $("#tasktitle").val(); // inputbox に入力された値を取得する
      if (tasktitle == "") return; //　もし、inputbox が空だった場合は関数を終了する
      let tasksubject = $("#tasksubject").val(); // inputbox に入力された値を取得する
      let datepicker = new Date($("#datepicker").val()); // inputbox に入力された値を取得する

      collection = db.collection("tasks").doc($('#docId').val())
        .update({ // $('#docId').val() で削除する対象データのIDを取得し、そのデータに対して更新を行う
          title: tasktitle, // 入力されたタスク名
          subject: tasksubject, // 入力されたタスク名
          duedate: datepicker, // 締切日
          duedateYY: datepicker.getFullYear(), // 締切日(年)
          duedateMM: datepicker.getMonth() + 1, // 締切日(月), getMonth(): 0 -> Januaryらしい
          duedateDD: datepicker.getDate(), // 締切日(日)
          duedateHH: ('00' + (datepicker.getHours())).slice(-2), // 締切日(時)
          duedateMIN: ('00' + (datepicker.getMinutes())).slice(-2) // 締切日(分)
        }).then(function () { // 成功した場合に実行される箇所
          console.log("Document successfully updated!");
          $('#list').text = "" // タスクをリスト表示するための箇所（<div id="list"></div>）を空文字に設定（初期化）
          // $("#addTask").modal('toggle'); // Modal の表示を OFF にする
          // getAll(); // 保持されている全てのタスクデータを取得し、表示する
          // $("#tasktitle").val(''); // inputbox に入力された値を空にする
          // $("#tasksubject").val(''); // inputbox に入力された値を空にする
          // $("#datepicker").val(''); // inputbox に入力された値を空にする
          window.location.reload();
        }).catch(function (error) { // 失敗した場合に実行される箇所
          console.error("Error removing document: ", error);
        });
    }

    // タスクの完了、未完了を制御する
    function check(elm) {
      db.collection("tasks").doc(elm.getAttribute('value'))
        .update({ // elm.getAttribute('value') で削除する対象データのIDを取得し、そのデータに対して更新を行う
          done: elm.checked, // 対象要素のチェック状態
        }).then(function () { // 成功した場合に実行される箇所
          console.log("Document successfully updated!");
        }).catch(function (error) { // 失敗した場合に実行される箇所
          console.error("Error removing document: ", error);
        });
    }

    let user_subjects = [];
    function getAllSubjects() {
      let collection = db.collection("users"); // 作成された順にデータを並べてタスクデータをデータベースから取得する
      collection.get().then((querySnapshot) => { // 取得したデータを読み取る
        // 変数の初期化
        querySnapshot.forEach((doc) => { // 取得したデータそれぞれ1つづつのデータに対して
          if (doc.id == user.uid) {
            user_subjects = doc.data()['subjects'];
            console.log("user_subjects: " + user_subjects);
            for (let i = 0; i < user_subjects.length; i++) {
              let day = 1;
              let period = 1;
              let pd = "";
              let first = true;
              let col = db.collection("subjects"); // subjectsをデータベースから取得する
              col.get().then((querySnapshot) => { // 取得したデータを読み取る
                querySnapshot.forEach((doc) => { // 取得したデータそれぞれ1つづつのデータに対して
                  if (doc.id == user_subjects[i] && first) {
                    pd = doc.data()['period'];
                    // console.log(pd + doc.data()['name']);
                    first = false;
                  }
                });
                const daynum = { "月": 1, "火": 2, "水": 3, "木": 4, "金": 5, "土": 6, "他": 6 };
                day = daynum[String(pd).charAt(0)];
                period = parseInt(String(pd).charAt(1));
                if (isNaN(period)) { period = 7; }

                let coll = db.collection("subjects"); // subjectsをデータベースから取得する
                first = true;
                coll.get().then((querySnapshot) => { // 取得したデータを読み取る
                  querySnapshot.forEach((doc) => { // 取得したデータそれぞれ1つづつのデータに対して
                    if (doc.id == user_subjects[i] && first) {
                      // console.log("day:" + day);
                      // console.log("period:" + period);
                      // console.log(doc.data()['name'] + '\n' + doc.data()['teacher']);
                      TABLE1.rows[period].cells[day].innerText = doc.data()['name'] + '\n' + doc.data()['teacher'];
                      $('#tasksubject').append($('<option>').html(doc.data()['name'] + ' - ' + doc.data()['teacher']).val(doc.data()['name'] + ' - ' + doc.data()['teacher']));
                      first = false;
                    }
                  });
                }).catch((error) => {
                  console.error("Error getting documents: ", error);
                });
              })

            }
          }
        });
      }).catch((error) => {
        console.error("Error getting documents: ", error);
      });

    }
    getAllSubjects(); // 保持されているuserの時間割を取得

    function addSubjectToUser() {
      let selected = $('#selectsubject').val(); // selectsubject で選択された値を取得する
      let subject = selected.split(" - ")[0];
      let teacher = selected.split(" - ")[1];

      let collection = db.collection("subjects"); // subjectsをデータベースから取得する
      collection.get().then((querySnapshot) => { // 取得したデータを読み取る
        querySnapshot.forEach((doc) => { // 取得したデータそれぞれ1つづつのデータに対して
          if (doc.data()['name'] == subject && doc.data()['teacher'] == teacher) {
            user_subjects.push(doc.id);
            console.log("pushed");
            updateUserSubjects();
          }
        });
      }).catch((error) => {
        console.error("Error getting documents: ", error);
      });
    }
    function updateUserSubjects() {
      db.collection("users").doc(user.uid).update({
        subjects: user_subjects
      }).then(() => {
        console.log("Document successfully updated!");
        // getAllSubjects();
        window.location.reload();

      })
        .catch((error) => {
          console.error("Error writing document: ", error);
        });
    }

    function delSubjectFromUser() {

    }

    // 新規タスクのためのモーダルを表示する
    function showNewModal(elm) {
      // $('#docId').val(elm.getAttribute('value')); // 選択したタスクデータのID を <input type="hidden" id="docId"> に設定
      $('#modalTitleLabel').text("新規タスクを作成"); // Modalのタイトル
      $('#OKBtn').css("display", "inline"); // 決定用のボタンを表示する
      $('#replaceBtn').css("display", "none"); // 更新用のボタンを非表示にする
      $('#deleteBtn').css("display", "none"); // 削除用のボタンを非表示にする
      $('#cancelBtn').css("display", "inline"); // キャンセルボタンを表示する
      $('#resetBtn').css("display", "inline"); // リセットボタンを表示する
      $('#editTask').css("display", "inline"); // タスク名を入力するための inputbox を表示する
      $('#warningMsg').css("display", "none"); // 削除用の警告メッセージを非表示にする


      $('#tasktitle').val('');
      $('#tasksubject').val('');
      $('#datepicker').val('');
    }

    // タスク更新のためのモーダルを表示する
    function showEditModal(elm) {
      $('#docId').val(elm.getAttribute('value')); // 選択したタスクデータのID を <input type="hidden" id="docId"> に設定
      $('#modalTitleLabel').text("タスクを修正"); // Modalのタイトル
      $('#OKBtn').css("display", "none"); // 決定用のボタンを非表示にする
      $('#replaceBtn').css("display", "inline"); // 更新用のボタンを表示する
      $('#deleteBtn').css("display", "none"); // 削除用のボタンを非表示にする
      $('#cancelBtn').css("display", "inline"); // キャンセルボタンを表示する
      $('#resetBtn').css("display", "none"); // リセットボタンを非表示にする
      $('#editTask').css("display", "inline"); // タスク名を入力するための inputbox を表示する
      $('#warningMsg').css("display", "none"); // 削除用の警告メッセージを非表示にする

      // データベースから値を読み込む
      let collection = db.collection("tasks").doc($('#docId').val());
      let title = "";
      let subject = "";
      let date = "";
      collection.get().then((doc) => {
        title = doc.data()['title'];
        subject = doc.data()['subject'];
        date = doc.data()['duedateYY'] + '-' + ('00' + doc.data()['duedateMM']).slice(-2) + '-' + ('00' + doc.data()['duedateDD']).slice(-2) + ' ' + doc.data()['duedateHH'] + ':' + doc.data()['duedateMIN'];

        $('#tasktitle').val(title);
        $('#tasksubject').val(subject);
        $('#datepicker').val(date);
      });
    }

    // タスク削除のためのモーダルを表示する
    function showDeleteModal(elm) {
      $('#docId').val(elm.getAttribute('value')); // 選択したタスクデータのID を <input type="hidden" id="docId"> に設定
      $('#modalTitleLabel').text("タスクを削除"); // Modalのタイトル
      $('#OKBtn').css("display", "none"); // 決定用のボタンを非表示にする
      $('#replaceBtn').css("display", "none"); // 更新用のボタンを非表示にする
      $('#deleteBtn').css("display", "inline"); // 削除用のボタンを表示する
      $('#cancelBtn').css("display", "inline"); // キャンセルボタンを表示する
      $('#resetBtn').css("display", "none"); // リセットボタンを非表示にする
      $('#editTask').css("display", "none"); // タスク名を入力するための inputbox を非表示にする
      $('#warningMsg').css("display", "inline"); // 削除用の警告メッセージを表示する
    }

    // // 教科追加のためのモーダルを表示する
    // function showNewSubjectModal(elm) {
    //   console.log(elm);
    //   console.log("hoge");
    //   $('#modalTitleLabel').text("科目を選択"); // Modalのタイトル
    //   $('#OKBtn').css("display", "inline"); // 決定用のボタンを表示する
    //   $('#replaceBtn').css("display", "none"); // 更新用のボタンを非表示にする
    //   $('#deleteBtn').css("display", "none"); // 削除用のボタンを非表示にする
    //   $('#cancelBtn').css("display", "inline"); // キャンセルボタンを表示する
    //   $('#resetBtn').css("display", "inline"); // リセットボタンを表示する
    //   $('#editTask').css("display", "inline"); // タスク名を入力するための inputbox を表示する
    //   $('#warningMsg').css("display", "none"); // 削除用の警告メッセージを非表示にする

    //   $('#subject').val('');
    // }

    const provider = new firebase.auth.GoogleAuthProvider();

    function signIn() {
      firebase.auth().signInWithPopup(provider)
        .then(result => {
          console.log('ログインしました。');

        }).catch(error => {
          const signinError = `
        サインインエラー
        エラーメッセージ： ${error.message}
        エラーコード: ${error.code}
            `
          console.error(signinError);
        });
    }

    function signOut() {
      firebase.auth().onAuthStateChanged(user => {
        firebase
          .auth()
          .signOut()
          .then(() => {
            console.log('ログアウトしました');
            location.reload();
          })
          .catch((error) => {
            console.error(`ログアウト時にエラーが発生しました(${error})`);
          });
      });
    }

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        const signOutMessage = `
          <p style="float: left; padding-right: 15px;"> ${user.displayName} <\/p>
          <img style="float: left;" id="profileImg" src="img/default.jpg" width="32px" height="32px" type = "submit"  onClick = "signOut()" >
            `;
        document.getElementById('profile').innerHTML = signOutMessage;

        console.log('ログインしています');
        let elem = document.getElementById("profileImg");
        elem.src = user.photoURL;
      } else {
        const signInMessage = `
        <img id="profileImg" src="img/default.jpg" width="32px" height="32px" type = "submit"  onClick = "signIn()" >
          `;
        document.getElementById('profile').innerHTML = signInMessage;
        let elem = document.getElementById("profileImg");
        elem.src = "img/default.jpg";
      }
    });

    // Firebase Authentication のPromiseオブジェクトを生成する関数を定義

    function genUser() {
      return new Promise((resolve, reject) => {
        firebase.auth().onAuthStateChanged(user => {
          if (user) {
            resolve(user);
          } else {
            return null;
          }
        });
      });
    }

    // Firebase の認証情報をResolveして処理ロジックに渡す
    let user = null;

    Promise.resolve(genUser()).then(user_ => {

      // user 内にGoogle認証を利用したユーザー情報が格納されている
      user = user_;
      console.log("user.uid: " + user_.uid);
      console.log("user.name: " + user_.displayName);

      // Databaseにユーザ情報がなければ追加する
      let isAdded = false;
      let collection = db.collection("users"); // 作成された順にデータを並べてタスクデータをデータベースから取得する
      collection.get().then((querySnapshot) => { // 取得したデータを読み取る
        querySnapshot.forEach((doc) => { // 取得したデータそれぞれ1つづつのデータに対して
          if (doc.id == user.uid) {
            isAdded = true;
          }
        });
        if (!isAdded) {
          db.collection("users").doc(user.uid).set({
            id: user.uid,
            name: user.displayName,
            subjects: []
          });
        }
      }).catch((error) => {
        console.error("Error getting documents: ", error);
      });

    });

    // push通知許可設定
    Notification.requestPermission().then((permission) => {
      if (permission === 'granted') {
        // 通知を許可した場合
        console.log('Notification permission granted.');
      } else {
        // 通知を拒否した場合
        console.log('Unable to get permission to notify.');
      }
    });
    const messaging = firebase.messaging();
    Notification.requestPermission().then((permission) => {
      if (permission === 'granted') {
        // 通知を許可した場合
        console.log('Notification permission granted.');

        messaging.getToken().then((currentToken) => {
          if (currentToken) {
            // トークン取得成功
            console.log("currentToken:");
            console.log(currentToken);
          } else {
            // トークン取得失敗
          }
        });
      } else {
        // 通知を拒否した場合
        console.log('Unable to get permission to notify.');
      }
    });

  </script>
  <script type="text/javascript" src="./js/add_subjects.js"></script>

  <!-- DatePicker -->
  <!-- https://deep-blog.jp/engineer/12727/ -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-datetimepicker/2.7.1/css/bootstrap-material-datetimepicker.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/locale/ja.js"></script>
  <!-- moment.jsを使って日本語対応 -->
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-datetimepicker/2.7.1/js/bootstrap-material-datetimepicker.min.js"></script>
  <script>
    // 締切日にフォーカスを当てたときにカレンダーを表示
    $(function () {
      $("#datepicker").bootstrapMaterialDatePicker({
        weekStart: 0,
        lang: "ja",
        format: "YYYY-MM-DD HH:mm"
      });
    });
  </script>

  <script>
    //table の初期化処理
    function initTable() {
      //table 内の td 要素をすべて取り出す。
      const list1 = [1, 2, 3, 4, 5];
      const list = document.querySelectorAll("td");
      // console.log(list1[0]);

      // (参考) list は NodeList。配列 Array に似ているけど Array ではないので注意。

      //td にクリックイベントを付ける。
      //NodeList を Array にして for of で処理する例。
      //array の場合は for of で処理できる。list のままだと for of は使えない。
      for (const td of Array.from(list)) {
        td.onclick = () => onclickTd(td);
      }
    }

    //tdがクリックされたときの処理
    function onclickTd(td) {
      try {
        const column = td.cellIndex;
        const tr = td.parentNode;
        const row = tr.sectionRowIndex;
        const text = td.textContent;
        console.log("td=" + td + "\t行row=" + row + "\t列column=" + column + "\t" + text);
        //クリックしたセルの色を青にする。
        if (text == "") {
          td.style.background = "#66f";
        }
      }
      catch (e) {
        console.error("Error:" + e);
      }
    }

    window.onload = function () {
      initTable();
    };
  </script>

  <title>Mintas</title>
</head>

<body>
  <header>
    <img class="logopic" src="img/logo.png">
    <div id="navarea">
      <nav>
        <div class="inner">
          <ul>
            <li><a href="#">menu1</a></li>
            <li><a href="#">menu2</a></li>
            <li><a href="#">menu3</a></li>
            <li><a href="#">menu4</a></li>
          </ul>
        </div>
      </nav>
      <div class="profile" id="profile">
        <!--<img id="profileImg" src="img/default.jpg" width="32px" height="32px" type = "submit"  onClick = "signIn()" >
         <span class="login"><a href="login.html">ログイン</a></span> -->
      </div>
      <div class="toggle_btn">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <div id="mask"></div>
    </div>
  </header>

  <div class="main">

    <div class="timetable">
      <table class="timetable" id="TABLE1" cellspacing="0" border="1">
        <thead>
          <tr>
            <!-- 1行目 -->
            <th scope="col" class="edge">#</th>
            <th scope="col" class="week">Mon.</th>
            <th scope="col" class="week">Tue.</th>
            <th scope="col" class="week">Wed.</th>
            <th scope="col" class="week">Thu.</th>
            <th scope="col" class="week">Fri.</th>
            <th scope="col" class="week">Sat.</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <!-- 2行目 -->
            <th scope="row" class="period">1</th>
            <!-- <td><a href="./lectures/1.html" target="_blank" title="複素関数論2">複素関数論2</a></td> 月曜１限 -->
            <td data-toggle="modal" data-target="#addSubject" data-whatever="mon1"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="tue1"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="wed1"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="thu1"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="fri1"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="sat1"></td>
          </tr>
          <tr>
            <th scope="row" class="period">2</th>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="mon2"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="tue2"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="wed2"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="thu2"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="fri2"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="sat2"></td>
          </tr>
          <tr>
            <th scope="row" class="period">3</th>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="mon3"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="tue3"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="wed3"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="thu3"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="fri3"></td>
            <td data-toggle="modal" data-target="#addSubject" data-whatever="sat3"></td>
          </tr>
          <tr>
            <th scope="row" class="period">4</th>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
          </tr>
          <tr>
            <th scope="row" class="period">5</th>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
          </tr>
          <tr>
            <th scope="row" class="period">6</th>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
          </tr>
          <tr>
            <th scope="row" class="period">7</th>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
            <td data-toggle="modal" data-target="#addSubject"></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="tasks">
      <h2 class="header">TODO</h2>
      <!-- 例
         <div class="detail">
        <span class="duedate">2021年8月19日 13:00</span>
        <span class="taskname">課題A</span>
        <span class="lecturename">複素関数論2</span>
      </div>
      <div class="detail">
        <span class="duedate">2021年8月20日 23:59</span>
        <span class="taskname">課題B</span>
        <span class="lecturename">複素関数論2</span>
      </div>
      -->

      <div id="list">

      </div>

      <div class="addbutton" style="position: absolute;">
        <button type="button" class="btn btn-primary" id="addBtn" data-toggle="modal" data-target="#addTask"
          onclick="showNewModal(this)">新規作成</button>
      </div>
    </div>
  </div>

  <!-- Modal(task) -->
  <div class="modal fade" id="addTask" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitleLabel">新規タスクを作成</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="docId"> <!-- 選択したタスクIDを管理する -->
          <form>
            <div class="container">
              <div class="row row-cols-1" id="editTask">
                <div class="col">タイトル</div>
                <div class="col">
                  <!-- タイトル -->
                  <input type="text" class="form-control" id="tasktitle" />
                </div>
                <div class="col">科目</div>
                <div class="col">
                  <!-- 科目 -->
                  <select class="form-control" id="tasksubject">
                  </select>
                </div>
                <div class="col">締切日</div>
                <div class="col">
                  <!-- 締切日 -->
                  <div class="btn-group">
                    <input type="text" class="form-control" id="datepicker" />
                    <span class="dateclear glyphicon glyphicon-remove-circle"></span>
                  </div>
                </div>
              </div>
              <p id="warningMsg">本当に削除してもよろしいですか？</p>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancelBtn" data-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-warning" id="resetBtn" onclick="reset()">リセット</button>
          <button type="button" class="btn btn-danger" id="deleteBtn" onclick="del()">削除</button>
          <button type="button" class="btn btn-primary" id="OKBtn" onclick="add()">決定</button>
          <button type="button" class="btn btn-success" id="replaceBtn" onclick="update()">更新</button>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    let sub = firebase.firestore();
    // 保有されている科目の取得
    function addAllSubjects() {
      let collection = sub.collection("subjects"); // 作成された順にデータを並べてタスクデータをデータベースから取得する
      collection.get().then((querySnapshot) => { // 取得したデータを読み取る
        $('sub').text('');
        querySnapshot.forEach((doc) => { // 取得したデータそれぞれ1つづつのデータに対して
          $('#selectsubject').append($('<option>').html(doc.data()['name'] + ' - ' + doc.data()['teacher']).val(doc.data()['name'] + ' - ' + doc.data()['teacher']));
          // console.log(doc.data()['name']);
        });
      });
    }
    addAllSubjects();
  </script>

  <!-- Modal(subject) -->
  <div class="modal fade" id="addSubject" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitleLabel"> 科目を登録</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="docId"> <!-- 選択したタスクIDを管理する -->
          <form>
            <div class="container">
              <div class="row row-cols-1" id="editTask">
                <div class="col">科目名</div>
                <div class="col">
                  <!-- 科目 -->
                  <select class="form-control" id="selectsubject">

                    <!--
                      <option>複素関数論2</option>
                      <option>Reading and Writing</option>
                    -->
                  </select>
                </div>
                <div class="col">
                </div>
              </div>
              <!-- <p id="warningMsg">本当に削除してもよろしいですか？</p> -->
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancelBtn" data-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-danger" id="deleteBtn" onclick="delSubjectFromUser()">削除</button>
          <button type="button" class="btn btn-primary" id="OKBtn" onclick="addSubjectToUser()">決定</button>
        </div>
      </div>
    </div>
  </div>
</body>

</html>